{% extends 'debate/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="control-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="mb-1">{{ session.title }}</h2>
                    <p class="text-muted mb-0">{{ session.topic }}</p>
                </div>
                <div class="text-end">
                    <div class="round-counter mb-2">
                        ë¼ìš´ë“œ {{ session.current_round }}/{{ session.max_rounds }}
                    </div>
                    <span class="status-badge status-{{ session.status }}">
                        {% if session.status == 'created' %}
                            ìƒì„±ë¨
                        {% elif session.status == 'in_progress' %}
                            ì§„í–‰ì¤‘
                        {% else %}
                            ì™„ë£Œë¨
                        {% endif %}
                    </span>
                </div>
            </div>

            {% if session.status != 'completed' %}
            <div class="d-flex gap-2">
                <button id="startDebateBtn" class="btn btn-success">
                    <i class="bi bi-play-circle"></i>
                    {% if session.status == 'created' %}
                        í† ë¡  ì‹œì‘
                    {% else %}
                        ë‹¤ìŒ ë°œì–¸
                    {% endif %}
                </button>
                <button id="autoModeBtn" class="btn btn-info" data-auto="false">
                    <i class="bi bi-arrow-repeat"></i> ìë™ ì§„í–‰
                </button>
            </div>
            {% else %}
            <div class="d-flex gap-2">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#evaluateModal">
                    <i class="bi bi-star"></i> í† ë¡  í‰ê°€í•˜ê¸°
                </button>
                <a href="{% url 'debate:create_session' %}" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle"></i> ìƒˆ í† ë¡  ì‹œì‘
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div id="messages-container">
            {% for message in messages %}
            <div class="message-card {% if message.speaker == 'ai1' %}ai1-message{% elif message.speaker == 'ai2' %}ai2-message{% else %}user-message{% endif %}">
                <div class="speaker-badge {% if message.speaker == 'ai1' %}ai1-badge{% elif message.speaker == 'ai2' %}ai2-badge{% else %}user-badge{% endif %}">
                    {% if message.speaker == 'user' %}
                        <i class="bi bi-person"></i> ì‚¬ìš©ì
                    {% elif message.speaker == 'ai1' %}
                        <i class="bi bi-robot"></i> AI1 (ê¸ì •)
                    {% else %}
                        <i class="bi bi-robot"></i> AI2 (ë¶€ì •)
                    {% endif %}
                    {% if message.round_number > 0 %}
                        - Round {{ message.round_number }}
                    {% endif %}
                </div>
                <div class="message-content">
                    {{ message.content|linebreaksbr }}
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">
                        {{ message.created_at|date:"Y-m-d H:i:s" }}
                    </small>
                    {% if message.response_time %}
                    <small class="text-muted">
                        <i class="bi bi-clock"></i> {{ message.response_time|floatformat:2 }}ì´ˆ
                    </small>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="loading-indicator" class="text-center py-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ì‘ë‹µ ìƒì„± ì¤‘...</span>
            </div>
            <p class="mt-2 text-muted">AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>
    </div>
</div>

<!-- í‰ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="evaluateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">í† ë¡  í‰ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="evaluateForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="ai1-badge">AI1 (ê¸ì •) í‰ê°€</h6>
                            <div class="mb-3">
                                <label class="form-label">ì ìˆ˜ (1-10)</label>
                                <select class="form-select" name="ai1_score" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for i in "0123456789"|make_list %}
                                        <option value="{{ forloop.counter }}">{{ forloop.counter }}ì </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ì½”ë©˜íŠ¸</label>
                                <textarea class="form-control" name="ai1_comment" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="ai2-badge">AI2 (ë¶€ì •) í‰ê°€</h6>
                            <div class="mb-3">
                                <label class="form-label">ì ìˆ˜ (1-10)</label>
                                <select class="form-select" name="ai2_score" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for i in "0123456789"|make_list %}
                                        <option value="{{ forloop.counter }}">{{ forloop.counter }}ì </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ì½”ë©˜íŠ¸</label>
                                <textarea class="form-control" name="ai2_comment" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ìŠ¹ì</label>
                        <select class="form-select" name="winner">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ai1">AI1 (ê¸ì •)</option>
                            <option value="ai2">AI2 (ë¶€ì •)</option>
                            <option value="draw">ë¬´ìŠ¹ë¶€</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì „ì²´ ì½”ë©˜íŠ¸</label>
                        <textarea class="form-control" name="overall_comment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="submitEvaluation">í‰ê°€ ì œì¶œ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startDebateBtn');
    const autoBtn = document.getElementById('autoModeBtn');
    const loadingIndicator = document.getElementById('loading-indicator');
    const messagesContainer = document.getElementById('messages-container');
    const sessionId = '{{ session.id }}';
    let autoMode = false;
    let isProcessing = false;

    startBtn.addEventListener('click', function() {
        if (!isProcessing) {
            startDebate();
        }
    });

    autoBtn.addEventListener('click', function() {
        autoMode = !autoMode;
        console.log('ìë™ ëª¨ë“œ í† ê¸€:', autoMode);
        if (autoMode) {
            autoBtn.innerHTML = '<i class="bi bi-pause-circle"></i> ìë™ ì¤‘ì§€';
            autoBtn.classList.remove('btn-info');
            autoBtn.classList.add('btn-warning');
            console.log('ìë™ ëª¨ë“œ ì‹œì‘, isProcessing:', isProcessing);
            if (!isProcessing) {
                console.log('ì²« ë²ˆì§¸ ìë™ ë°œì–¸ ì‹œì‘');
                startDebate();
            }
        } else {
            console.log('ìë™ ëª¨ë“œ ì¤‘ì§€');
            autoBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> ìë™ ì§„í–‰';
            autoBtn.classList.remove('btn-warning');
            autoBtn.classList.add('btn-info');
        }
    });

    function startDebate() {
        if (isProcessing) return;

        isProcessing = true;
        startBtn.disabled = true;
        loadingIndicator.style.display = 'block';

        fetch(`/session/${sessionId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // í† ë¡  ì™„ë£Œ ì²˜ë¦¬ë¥¼ ë¨¼ì € í™•ì¸
            if (data.completed) {
                console.log('í† ë¡  ì™„ë£Œë¨');
                alert('ğŸ‰ í† ë¡ ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ëª¨ë“  ë¼ìš´ë“œê°€ ëë‚¬ìŠµë‹ˆë‹¤.');
                isProcessing = false;
                startBtn.disabled = false;
                autoMode = false;
                autoBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> ìë™ ì§„í–‰';
                autoBtn.classList.remove('btn-warning');
                autoBtn.classList.add('btn-info');
                startBtn.style.display = 'none';
                autoBtn.style.display = 'none';
                setTimeout(() => location.reload(), 1000);
                return;
            }

            if (data.success) {
                addMessage(data.message);
                updateSessionInfo(data.session);

                if (autoMode && data.session && data.session.status !== 'completed') {
                    // ìë™ ëª¨ë“œ: ì²˜ë¦¬ ìƒíƒœ í•´ì œ í›„ 2ì´ˆ í›„ ë‹¤ìŒ ë°œì–¸ ì§„í–‰
                    console.log('ìë™ ëª¨ë“œ í™œì„± - 2ì´ˆ í›„ ë‹¤ìŒ ë°œì–¸ ì‹œì‘');
                    console.log('í˜„ì¬ ë¼ìš´ë“œ:', data.session.current_round, '/', data.session.max_rounds);
                    isProcessing = false;
                    startBtn.disabled = false;
                    setTimeout(() => {
                        if (autoMode) { // íƒ€ì´ë¨¸ ë™ì•ˆ ìë™ëª¨ë“œê°€ í•´ì œë˜ì§€ ì•Šì•˜ë‹¤ë©´
                            console.log('ìë™ ëª¨ë“œë¡œ ë‹¤ìŒ ë°œì–¸ ì‹œì‘');
                            startDebate();
                        }
                    }, 2000);
                } else {
                    // ìˆ˜ë™ ëª¨ë“œ ë˜ëŠ” í† ë¡  ì™„ë£Œ: ë²„íŠ¼ í™œì„±í™”
                    isProcessing = false;
                    startBtn.disabled = false;
                    if (data.session && data.session.status === 'completed') {
                        autoMode = false; // í† ë¡  ì™„ë£Œì‹œ ìë™ ëª¨ë“œ í•´ì œ
                        autoBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> ìë™ ì§„í–‰';
                        autoBtn.classList.remove('btn-warning');
                        autoBtn.classList.add('btn-info');
                        alert('ğŸ‰ í† ë¡ ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        startBtn.style.display = 'none';
                        autoBtn.style.display = 'none';
                        setTimeout(() => location.reload(), 1000);
                    }
                }
            } else {
                alert('ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
                isProcessing = false;
                startBtn.disabled = false;
                // ì˜¤ë¥˜ ë°œìƒì‹œ ìë™ ëª¨ë“œ í•´ì œ
                autoMode = false;
                autoBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> ìë™ ì§„í–‰';
                autoBtn.classList.remove('btn-warning');
                autoBtn.classList.add('btn-info');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            isProcessing = false;
            startBtn.disabled = false;
            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì‹œ ìë™ ëª¨ë“œ í•´ì œ
            autoMode = false;
            autoBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> ìë™ ì§„í–‰';
            autoBtn.classList.remove('btn-warning');
            autoBtn.classList.add('btn-info');
        })
        .finally(() => {
            loadingIndicator.style.display = 'none';
        });
    }

    function addMessage(messageData) {
        const messageDiv = document.createElement('div');
        const speakerClass = messageData.speaker === 'ai1' ? 'ai1-message' : 'ai2-message';
        const badgeClass = messageData.speaker === 'ai1' ? 'ai1-badge' : 'ai2-badge';
        const speakerName = messageData.speaker === 'ai1' ? 'AI1 (ê¸ì •)' : 'AI2 (ë¶€ì •)';

        messageDiv.className = `message-card ${speakerClass}`;
        messageDiv.innerHTML = `
            <div class="speaker-badge ${badgeClass}">
                <i class="bi bi-robot"></i> ${speakerName} - Round ${messageData.round_number}
            </div>
            <div class="message-content">
                ${messageData.content.replace(/\n/g, '<br>')}
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">
                    ${new Date(messageData.created_at).toLocaleString()}
                </small>
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        messageDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function updateSessionInfo(sessionData) {
        const roundCounter = document.querySelector('.round-counter');
        if (roundCounter) {
            roundCounter.textContent = `ë¼ìš´ë“œ ${sessionData.current_round}/${sessionData.max_rounds}`;
        }
    }

    // í‰ê°€ ì œì¶œ
    const submitButton = document.getElementById('submitEvaluation');
    if (submitButton) {
        console.log('í‰ê°€ ì œì¶œ ë²„íŠ¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.');
        submitButton.addEventListener('click', function(event) {
            event.preventDefault();
            console.log('í‰ê°€ ì œì¶œ ë²„íŠ¼ í´ë¦­ë¨!');

            const form = document.getElementById('evaluateForm');
            if (!form) {
                console.error('í‰ê°€ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                alert('í‰ê°€ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            console.log('ìˆ˜ì§‘ëœ í¼ ë°ì´í„°:', data);
            console.log('CSRF í† í°:', csrftoken);
            console.log('ì„¸ì…˜ ID:', sessionId);

            // í•„ìˆ˜ í•­ëª© ê²€ì¦
            if (!data.ai1_score || !data.ai2_score) {
                console.log('í•„ìˆ˜ ì ìˆ˜ ëˆ„ë½ - ai1_score:', data.ai1_score, 'ai2_score:', data.ai2_score);
                alert('AI1ê³¼ AI2ì˜ ì ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('í‰ê°€ ì œì¶œ ìš”ì²­ ì‹œì‘...');
            fetch(`/session/${sessionId}/evaluate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('ì„œë²„ ì‘ë‹µ ë°›ìŒ:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('í‰ê°€ ì œì¶œ ì‘ë‹µ:', data);
                if (data.success) {
                    alert('í‰ê°€ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    // ëª¨ë‹¬ ë‹«ê¸°
                    const modal = bootstrap.Modal.getInstance(document.getElementById('evaluateModal'));
                    if (modal) {
                        modal.hide();
                    }
                    setTimeout(() => location.reload(), 500);
                } else {
                    alert('í‰ê°€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            })
            .catch(error => {
                console.error('í‰ê°€ ì œì¶œ ì—ëŸ¬:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        });
    } else {
        console.error('í‰ê°€ ì œì¶œ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    }
});
</script>
{% endblock %}